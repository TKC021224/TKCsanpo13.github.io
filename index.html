<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•£æ­©ãƒ«ãƒ¼ãƒˆã¯ä¿ºãŒå‰µã‚‹!!!</title> <!-- ã‚¢ãƒ—ãƒªåã‚’å¤‰æ›´ -->
    <!-- Tailwind CSS CDNã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSSã‚’èª­ã¿è¾¼ã¿ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ï¼ˆTailwindã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ãŒæ˜ç¤ºçš„ã«ï¼‰ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f8ff; /* æ·¡ã„é’ã®èƒŒæ™¯ */
        }
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        #map {
            /* Leafletåœ°å›³ãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´æ‰€ */
            /* Tailwindã®h-64 (256px) / sm:h-80 (320px) ã«åˆã‚ã›ã¦å›ºå®šé«˜ã•ã‚’è¨­å®š */
            height: 320px; /* ã“ã“ã§å›ºå®šã®é«˜ã•ã‚’æŒ‡å®šï¼ */
            width: 100%; /* w-full ã¨åŒã˜ */
            border-radius: 1rem; /* rounded-xl ã¨åŒã˜ */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md ã¨åŒã˜ */
            background-color: #e0e0e0; /* åœ°å›³èª­ã¿è¾¼ã¿ä¸­ã®èƒŒæ™¯è‰² */
            display: block; /* ãƒ–ãƒ­ãƒƒã‚¯è¦ç´ ã¨ã—ã¦ç¢ºå®Ÿã«é«˜ã•ã‚’ç¢ºä¿ */
        }
        .scroll-container {
            max-height: 150px; /* æ¡ˆå†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ã®é«˜ã•åˆ¶é™ */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* iOSã§ã®ã‚¹ãƒ ãƒ¼ã‚ºãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        }
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆä»»æ„ï¼‰ */
        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #555;
            border-radius: 10px;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .custom-modal {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 400px;
            text-align: center;
        }
        .custom-modal button {
            margin: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; /* full rounded */
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .custom-modal input {
            width: calc(100% - 2rem); /* paddingã‚’è€ƒæ…® */
            padding: 0.75rem;
            margin-top: 1rem;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4 sm:p-6 bg-gradient-to-br from-blue-100 to-purple-100">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="w-full max-w-2xl bg-gradient-to-r from-purple-500 to-pink-500 text-white p-5 rounded-xl shadow-lg mb-6 text-center">
        <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">
            æ•£æ­©ãƒ«ãƒ¼ãƒˆã¯ä¿ºãŒå‰µã‚‹!!! ğŸš¶â€â™€ï¸âœ¨ <!-- ã‚¢ãƒ—ãƒªåã‚’å¤‰æ›´ -->
        </h1>
        <p class="mt-2 text-lg sm:text-xl font-medium">
            æ­©ããŸã„è·é›¢ã‚’å…¥åŠ›ã—ã¦ã€æ–°ã—ã„ãƒ«ãƒ¼ãƒˆã‚’è¦‹ã¤ã‘ã‚ˆã†ï¼
        </p>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="w-full max-w-2xl bg-white p-6 rounded-xl shadow-xl space-y-6">

        <!-- è·é›¢å…¥åŠ›ã¨ãƒœã‚¿ãƒ³ -->
        <section class="flex flex-col sm:flex-row items-center justify-center gap-4">
            <input
                type="number"
                id="distanceInput"
                placeholder="æ­©ããŸã„è·é›¢ (km) ã‚’å…¥åŠ›ã—ã¦ã­ï¼"
                class="flex-grow w-full sm:w-auto p-3 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg text-gray-700 placeholder-gray-400 font-medium"
                min="0.1"
                step="0.1"
            >
            <button
                id="generateRouteButton"
                class="w-full sm:w-auto bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:from-green-500 hover:to-blue-600 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-300"
            >
                ãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹ï¼ğŸ—ºï¸
            </button>
        </section>

        <!-- åœ°å›³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <section class="relative w-full rounded-xl shadow-md overflow-hidden bg-gray-200 flex items-center justify-center">
            <div id="map" class="w-full"></div>
            <!-- åœ°å›³èª­ã¿è¾¼ã¿ä¸­ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
            <div id="mapLoading" class="absolute inset-0 flex items-center justify-center bg-gray-200 bg-opacity-75 text-gray-600 font-bold text-xl z-10">
                åœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­... ğŸŒ
            </div>
        </section>

        <!-- éŸ³å£°æ¡ˆå†…ã¨æ¡ˆå†…è¡¨ç¤º -->
        <section class="bg-white p-5 rounded-xl shadow-md border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">
                éŸ³å£°æ¡ˆå†… ğŸ—£ï¸
            </h2>
            <div id="guidanceDisplay" class="scroll-container bg-blue-50 p-4 rounded-lg border border-blue-200 text-gray-700 text-base leading-relaxed mb-4">
                <p class="text-center text-gray-500">ãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã¨ã€ã“ã“ã«æ¡ˆå†…ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆï¼</p>
            </div>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button
                    id="startGuidanceButton"
                    class="w-full sm:w-auto bg-gradient-to-r from-orange-400 to-red-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:from-orange-500 hover:to-red-600 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-orange-300"
                    disabled
                >
                    ãŠæ•£æ­©ã‚¹ã‚¿ãƒ¼ãƒˆï¼â–¶ï¸
                </button>
                <button
                    id="checkArrivalButton"
                    class="w-full sm:w-auto bg-gradient-to-r from-teal-400 to-cyan-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:from-teal-500 hover:to-cyan-600 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-teal-300"
                    disabled
                >
                    åˆ°ç€ç¢ºèªï¼âœ…
                </button>
                <button
                    id="nextGuidanceButton"
                    class="w-full sm:w-auto bg-gradient-to-r from-purple-400 to-indigo-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:from-purple-500 hover:to-indigo-600 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-300"
                    disabled
                >
                    æ¬¡ã®æ¡ˆå†…ã¸ï¼ğŸ‘‰ (æ‰‹å‹•)
                </button>
            </div>
        </section>

        <!-- é€šå¸¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ -->
        <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="custom-modal">
                <p id="messageText" class="text-xl font-semibold text-gray-800 mb-6"></p>
                <button id="closeMessageBox" class="bg-blue-500 text-white hover:bg-blue-600">OKï¼</button>
            </div>
        </div>

        <!-- åˆ°ç€ç¢ºèªç”¨ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="arrivalConfirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="custom-modal">
                <p id="arrivalConfirmationText" class="text-xl font-semibold text-gray-800 mb-6">ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã—ãŸã‹ï¼Ÿ</p>
                <div class="flex justify-center gap-4">
                    <button id="confirmArrivalYes" class="bg-green-500 text-white hover:bg-green-600">ã¯ã„ï¼</button>
                    <button id="confirmArrivalNo" class="bg-red-500 text-white hover:bg-red-600">ã„ã„ãˆã€é•ã„ã¾ã—ãŸ</button>
                </div>
            </div>
        </div>

        <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å…¥åŠ›ç”¨ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="feedbackModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="custom-modal">
                <p class="text-xl font-semibold text-gray-800 mb-4">æ­£ã—ã„å ´æ‰€ã®åå‰ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚</p>
                <input type="text" id="feedbackInput" placeholder="ä¾‹: ã€‡ã€‡æ›¸åº—" class="mb-4">
                <button id="submitFeedback" class="bg-blue-500 text-white hover:bg-blue-600">é€ä¿¡ï¼</button>
                <button id="cancelFeedback" class="bg-gray-400 text-white hover:bg-gray-500">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>

    </main>

    <!-- Leaflet JavaScriptã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // DOMè¦ç´ ã®å–å¾—
        const distanceInput = document.getElementById('distanceInput');
        const generateRouteButton = document.getElementById('generateRouteButton');
        const guidanceDisplay = document.getElementById('guidanceDisplay');
        const startGuidanceButton = document.getElementById('startGuidanceButton');
        const checkArrivalButton = document.getElementById('checkArrivalButton');
        const nextGuidanceButton = document.getElementById('nextGuidanceButton');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessageBox = document.getElementById('closeMessageBox');

        // æ–°ã—ãè¿½åŠ ã—ãŸãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ 
        const arrivalConfirmationModal = document.getElementById('arrivalConfirmationModal');
        const confirmArrivalYes = document.getElementById('confirmArrivalYes');
        const confirmArrivalNo = document.getElementById('confirmArrivalNo');
        const feedbackModal = document.getElementById('feedbackModal');
        const feedbackInput = document.getElementById('feedbackInput');
        const submitFeedback = document.getElementById('submitFeedback');
        const cancelFeedback = document.getElementById('cancelFeedback');
        const mapLoading = document.getElementById('mapLoading');

        let currentRouteGuidance = []; // ç”Ÿæˆã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆæ¡ˆå†…ãƒ†ã‚­ã‚¹ãƒˆã¨ç›®çš„åœ°åº§æ¨™ã®é…åˆ—
        let currentGuidanceIndex = 0; // ç¾åœ¨ã®æ¡ˆå†…ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        let currentDestinationMarkers = []; // ç›®çš„åœ°ãƒãƒ¼ã‚«ãƒ¼ã‚’ä¿æŒã™ã‚‹é…åˆ—
        let highlightedMarker = null; // ç¾åœ¨å¼·èª¿è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚«ãƒ¼

        let map; // Leafletãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let currentMarker; // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let currentRoutePolyline; // ç¾åœ¨ã®ãƒ«ãƒ¼ãƒˆç·šï¼ˆãƒãƒªãƒ©ã‚¤ãƒ³ï¼‰ã‚’ä¿æŒã™ã‚‹å¤‰æ•°

        // ç¾åœ¨ã®ç·¯åº¦çµŒåº¦ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let currentLat = 35.681236; // æ±äº¬é§…ã®ç·¯åº¦ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
        let currentLon = 139.767125; // æ±äº¬é§…ã®çµŒåº¦ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š

        // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³ã®å®šç¾©
        const defaultIcon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        const highlightedIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', // èµ¤è‰²ã®ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³
            iconRetinaUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // ãƒ€ãƒŸãƒ¼ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ (æ±äº¬é§…å‘¨è¾ºã®å®Ÿéš›ã®å ´æ‰€ã‚’å‚è€ƒã«)
        // ç·¯åº¦çµŒåº¦ã¯ã‚ãã¾ã§å‚è€ƒå€¤ã§ã€æ­£ç¢ºãªã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
        const landmarkData = [
            { name: 'è¿‘ç•¿å¤§å­¦æ±äº¬ã‚»ãƒ³ã‚¿ãƒ¼', lat: 35.6806, lon: 139.7686 },
            { name: 'ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ›ãƒ†ãƒ«LOHASæ±äº¬é§…å…«é‡æ´²ä¸­å¤®å£', lat: 35.6805, lon: 139.7698 },
            { name: 'ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰å…«é‡æ´²é€šã‚Šåº—', lat: 35.6792, lon: 139.7701 },
            { name: 'æ±äº¬å›½éš›ãƒ•ã‚©ãƒ¼ãƒ©ãƒ ', lat: 35.6769, lon: 139.7638 },
            { name: 'ä¸¸ã®å†…ä»²é€šã‚Š', lat: 35.6806, lon: 139.7641 },
            { name: 'çš‡å±…å¤–è‹‘', lat: 35.6846, lon: 139.7532 },
            { name: 'æ—¥æœ¬æ©‹ä¸‰è¶Šæœ¬åº—', lat: 35.6865, lon: 139.7738 },
            { name: 'KITTEä¸¸ã®å†…', lat: 35.6808, lon: 139.7656 },
            { name: 'å…«é‡æ´²åœ°ä¸‹è¡—', lat: 35.6808, lon: 139.7682 },
            { name: 'æ±äº¬é§…ä¸€ç•ªè¡—', lat: 35.6816, lon: 139.7680 },
            { name: 'æ—¥æ¯”è°·å…¬åœ’', lat: 35.6762, lon: 139.7570 },
            { name: 'éŠ€åº§å››ä¸ç›®äº¤å·®ç‚¹', lat: 35.6720, lon: 139.7640 },
            { name: 'äº¬æ©‹ã‚¨ãƒ‰ã‚°ãƒ©ãƒ³', lat: 35.6789, lon: 139.7693 },
            { name: 'ãƒ–ãƒªãƒ‚ã‚¹ãƒˆãƒ³æœ¬ç¤¾', lat: 35.6801, lon: 139.7712 },
            { name: 'ãƒ­ãƒ¼ã‚½ãƒ³ã€‡ã€‡åº—', lat: 35.6800, lon: 139.7670 }, // æ–°ã—ã„ãƒ€ãƒŸãƒ¼åº—èˆ—
            { name: 'ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³ã€‡ã€‡åº—', lat: 35.6810, lon: 139.7690 },
            { name: 'ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆã€‡ã€‡åº—', lat: 35.6795, lon: 139.7665 },
            { name: 'ã€‡ã€‡å…¬åœ’', lat: 35.6750, lon: 139.7600 },
            { name: 'ã€‡ã€‡äº¤ç•ª', lat: 35.6820, lon: 139.7650 },
            { name: 'ã€‡ã€‡ç—…é™¢', lat: 35.6780, lon: 139.7620 },
            { name: 'ã€‡ã€‡éŠ€è¡Œ', lat: 35.6830, lon: 139.7705 }
        ];

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showMessageBox(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’é–‰ã˜ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        closeMessageBox.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        // 2ç‚¹é–“ã®è·é›¢ã‚’ãƒ¡ãƒ¼ãƒˆãƒ«ã§è¨ˆç®—ã™ã‚‹é–¢æ•° (Haversine formula)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // åœ°çƒã®åŠå¾„ (ãƒ¡ãƒ¼ãƒˆãƒ«)
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const d = R * c; // è·é›¢ (ãƒ¡ãƒ¼ãƒˆãƒ«)
            return d;
        }

        // ç·¯åº¦çµŒåº¦ã‚’æ–‡å­—åˆ—ã‚­ãƒ¼ã«å¤‰æ›ã™ã‚‹é–¢æ•°ï¼ˆå°æ•°ç‚¹ä»¥ä¸‹5æ¡ã§ä¸¸ã‚ã‚‹ï¼‰
        function coordsToKey(lat, lon) {
            return `${lat.toFixed(5)},${lon.toFixed(5)}`;
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’èª­ã¿è¾¼ã‚€
        function loadFeedback() {
            try {
                const feedbackJson = localStorage.getItem('walk_app_corrections');
                return feedbackJson ? JSON.parse(feedbackJson) : {};
            } catch (e) {
                console.error("Failed to load feedback from localStorage:", e);
                return {};
            }
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ä¿å­˜ã™ã‚‹
        function saveFeedback(key, correctedName) {
            const corrections = loadFeedback();
            corrections[key] = correctedName;
            try {
                localStorage.setItem('walk_app_corrections', JSON.stringify(corrections));
                console.log(`Feedback saved: ${key} -> ${correctedName}`);
            } catch (e) {
                console.error("Failed to save feedback to localStorage:", e);
                showMessageBox('ã”ã‚ã‚“ã­ï¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ä¿å­˜ã§ããªã‹ã£ãŸã¿ãŸã„...ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ã­ï¼');
            }
        }

        // ãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
        generateRouteButton.addEventListener('click', () => {
            const distance = parseFloat(distanceInput.value);

            if (isNaN(distance) || distance <= 0) {
                showMessageBox('æœ‰åŠ¹ãªæ­©è¡Œè·é›¢ï¼ˆæ•°å­—ï¼‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼');
                return;
            }

            // ä»¥å‰ã®ãƒ«ãƒ¼ãƒˆç·šã¨ç›®çš„åœ°ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
            if (currentRoutePolyline) {
                map.removeLayer(currentRoutePolyline);
            }
            currentDestinationMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            currentDestinationMarkers = [];
            highlightedMarker = null; // å¼·èª¿è¡¨ç¤ºãƒãƒ¼ã‚«ãƒ¼ã‚‚ãƒªã‚»ãƒƒãƒˆ

            currentRouteGuidance = [];
            currentGuidanceIndex = 0;

            const basePoints = 2; // ã‚¹ã‚¿ãƒ¼ãƒˆã¨ã‚´ãƒ¼ãƒ«
            const pointsPerKm = 2; // 1kmã‚ãŸã‚Šã®è¿½åŠ ç›®çš„åœ°æ•°
            const numPoints = basePoints + Math.floor(distance * pointsPerKm); // ãƒ«ãƒ¼ãƒ—å†…ã®åˆè¨ˆãƒã‚¤ãƒ³ãƒˆæ•°

            const latPerKm = 0.009; // ç·¯åº¦1kmã‚ãŸã‚Šã®åº¦æ•° (ãŠãŠã‚ˆã)
            const lonPerKm = 0.011; // çµŒåº¦1kmã‚ãŸã‚Šã®åº¦æ•° (æ±äº¬ä»˜è¿‘ã§ã®1kmã‚ãŸã‚Šã®åº¦æ•°)

            const storedCorrections = loadFeedback(); // è¨˜æ†¶ã—ãŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’èª­ã¿è¾¼ã‚€

            currentRouteGuidance.push({ text: 'ãŠæ•£æ­©ã‚’é–‹å§‹ã—ã¾ã™ï¼è‰¯ã„ãŠå¤©æ°—ã ã­ï¼â˜€ï¸', targetCoords: [currentLat, currentLon] });
            const routeCoordinates = [[currentLat, currentLon]]; // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹

            let tempLat = currentLat;
            let tempLon = currentLon;

            // ãƒ«ãƒ¼ãƒ—ç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
            const totalRotations = 1 + (distance / 5); // è·é›¢ãŒé•·ã„ã»ã©å›è»¢æ•°ã‚’å¢—ã‚„ã™ï¼ˆä¾‹: 5kmã§2å‘¨ï¼‰
            const angleIncrementPerStep = (totalRotations * Math.PI * 2) / (numPoints - 1); // å„ã‚¹ãƒ†ãƒƒãƒ—ã§ã®è§’åº¦å¢—åˆ†
            let currentAngle = Math.random() * Math.PI * 2; // ãƒ©ãƒ³ãƒ€ãƒ ãªé–‹å§‹è§’åº¦

            // ãƒ«ãƒ¼ãƒˆã®æœ€å¤§åŠå¾„ (km) ã‚’è·é›¢ã¨å›è»¢æ•°ã«å¿œã˜ã¦è¨ˆç®—
            // å††å‘¨ = 2 * Ï€ * åŠå¾„ ãªã®ã§ã€åŠå¾„ = å††å‘¨ / (2 * Ï€)
            // ã“ã“ã§ã¯è·é›¢ãŒå††å‘¨ã®ç›®å®‰ãªã®ã§ã€ maxRadiusKm = distance / (2 * Math.PI * totalRotations)
            // ã•ã‚‰ã«ã€ãƒ«ãƒ¼ãƒˆãŒä¸­å¿ƒã‹ã‚‰åºƒãŒã‚Šã™ããªã„ã‚ˆã†ã«èª¿æ•´ä¿‚æ•°ã‚’ã‹ã‘ã‚‹
            const maxRadiusKm = distance / (2 * Math.PI * totalRotations) * 0.8; // 0.8ã¯èª¿æ•´ä¿‚æ•°

            // ä¸­é–“åœ°ç‚¹ã‚’ç”Ÿæˆ (ã‚¹ã‚¿ãƒ¼ãƒˆã¨æœ€çµ‚ã‚´ãƒ¼ãƒ«ã‚’é™¤ã)
            for (let i = 1; i < numPoints - 1; i++) {
                // åŠå¾„ã‚’è¨ˆç®—: 0ã‹ã‚‰maxRadiusKmã¸ã€ãã—ã¦0ã¸æˆ»ã‚‹ (ã‚µã‚¤ãƒ³æ³¢ã‚’åˆ©ç”¨)
                const radiusFactor = Math.sin((i / (numPoints - 2)) * Math.PI); // 0ã‹ã‚‰1ã¸ã€ãã—ã¦0ã¸æˆ»ã‚‹
                const currentRadius = maxRadiusKm * radiusFactor;

                // ç·¯åº¦çµŒåº¦ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¨ˆç®—
                const latOffset = currentRadius * Math.sin(currentAngle) * latPerKm;
                const lonOffset = currentRadius * Math.cos(currentAngle) * lonPerKm;

                tempLat = currentLat + latOffset;
                tempLon = currentLon + lonOffset;

                // ã”ãã‚ãšã‹ãªãƒ©ãƒ³ãƒ€ãƒ ãªãƒ–ãƒ¬ã‚’åŠ ãˆã‚‹ï¼ˆé“å¹…ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¤ã¤ã€ç›´äº¤æ€§ã‚’ä¿ã¤ï¼‰
                // è§’åº¦ã«ç›´æ¥ãƒ–ãƒ¬ã‚’åŠ ãˆã‚‹ã®ã§ã¯ãªãã€ç›´äº¤æ–¹å‘ã«å°ã•ãªãƒ–ãƒ¬ã‚’åŠ ãˆã‚‹ã“ã¨ã§ã€
                // é“ã«æ²¿ã£ãŸæ„Ÿã˜ã‚’ä¿ã¡ã¤ã¤ã€å˜èª¿ã•ã‚’ãªãã™
                const jitterMagnitude = 0.000005; // éå¸¸ã«å°ã•ãªãƒ–ãƒ¬
                tempLat += (Math.random() - 0.5) * jitterMagnitude;
                tempLon += (Math.random() - 0.5) * jitterMagnitude;


                routeCoordinates.push([tempLat, tempLon]);

                const randomLandmarkName = landmarkData[Math.floor(Math.random() * landmarkData.length)].name;
                const landmarkKey = coordsToKey(tempLat, tempLon);
                const displayName = storedCorrections[landmarkKey] || randomLandmarkName;

                currentRouteGuidance.push({
                    text: `æ¬¡ã«${displayName}ã¾ã§å‘ã‹ã£ã¦ãã ã•ã„ã€‚`,
                    targetCoords: [tempLat, tempLon],
                    originalName: randomLandmarkName // å…ƒã®ææ¡ˆåã‚’ä¿å­˜
                });

                currentAngle += angleIncrementPerStep; // è§’åº¦ã‚’æ›´æ–°ã—ã¦èºæ—‹ã‚’æã
            }

            // æœ€å¾Œã®æ¡ˆå†…ã¯ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã«æˆ»ã‚‹æŒ‡ç¤º
            currentRouteGuidance.push({ text: 'æœ€åˆã®åœ°ç‚¹ã«æˆ»ã£ã¦ãã ã•ã„ã€‚', targetCoords: [currentLat, currentLon] });
            routeCoordinates.push([currentLat, currentLon]); // ãƒ«ãƒ¼ãƒˆã®æœ€å¾Œã«ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã‚’è¿½åŠ 

            currentRouteGuidance.push({ text: 'ã‚´ãƒ¼ãƒ«ã ã‚ˆï¼ãŠæ•£æ­©ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ğŸŒ¸', targetCoords: null });

            // ãƒ«ãƒ¼ãƒˆç·šã‚’åœ°å›³ã«æç”»
            currentRoutePolyline = L.polyline(routeCoordinates, {color: 'blue', weight: 5, opacity: 0.7}).addTo(map);

            // å„ç›®çš„åœ°ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            // æœ€åˆã®ç‚¹ (ç¾åœ¨åœ°) ã¨æœ€å¾Œã®ç‚¹ (ã‚´ãƒ¼ãƒ«) ã‚’é™¤ã
            for (let i = 1; i < routeCoordinates.length - 1; i++) {
                const coord = routeCoordinates[i];
                const guidanceItem = currentRouteGuidance[i];
                // ãƒãƒ¼ã‚«ãƒ¼ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã§è¿½åŠ 
                const marker = L.marker(coord, { icon: defaultIcon }).addTo(map)
                    .bindPopup(guidanceItem.text.replace('æ¬¡ã«', '').replace('ã¾ã§å‘ã‹ã£ã¦ãã ã•ã„ã€‚', '')); // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã«æ¡ˆå†…ã‚’è¡¨ç¤º
                currentDestinationMarkers.push(marker);
            }

            map.fitBounds(currentRoutePolyline.getBounds()); // ãƒ«ãƒ¼ãƒˆå…¨ä½“ãŒç”»é¢ã«åã¾ã‚‹ã‚ˆã†ã«èª¿æ•´

            // ã™ã¹ã¦ã®æ¡ˆå†…ã‚’è¡¨ç¤º (å¼·èª¿è¡¨ç¤ºã‚‚ã“ã“ã§åˆæœŸåŒ–ã•ã‚Œã‚‹)
            updateGuidanceDisplay();

            showMessageBox(`ãŠæ•£æ­©ãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆã—ãŸã‚ˆï¼å…¨${currentRouteGuidance.length}ã‚¹ãƒ†ãƒƒãƒ—ã ã‚ˆï¼`);

            // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–
            startGuidanceButton.disabled = false;
            checkArrivalButton.disabled = false;
            nextGuidanceButton.disabled = false;
        });

        // éŸ³å£°æ¡ˆå†…ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
        startGuidanceButton.addEventListener('click', () => {
            if (currentRouteGuidance.length === 0) {
                showMessageBox('ã¾ãšãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ã­ï¼');
                return;
            }
            currentGuidanceIndex = 0; // æœ€åˆã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
            speakGuidance(currentRouteGuidance[currentGuidanceIndex].text);
            updateGuidanceDisplay();
        });

        // åˆ°ç€ç¢ºèªãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        checkArrivalButton.addEventListener('click', () => {
            if (currentGuidanceIndex >= currentRouteGuidance.length - 1) { // æœ€å¾Œã®æ¡ˆå†…ï¼ˆã‚´ãƒ¼ãƒ«ï¼‰ä»¥é™ã¯ç¢ºèªä¸è¦
                showMessageBox('ã‚‚ã†ã‚´ãƒ¼ãƒ«ã—ã¦ã‚‹ã‚ˆï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ğŸ˜Š');
                return;
            }

            // åˆ°ç€ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            arrivalConfirmationModal.classList.remove('hidden');
        });

        // åˆ°ç€ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã€Œã¯ã„ï¼ã€ãƒœã‚¿ãƒ³
        confirmArrivalYes.addEventListener('click', () => {
            arrivalConfirmationModal.classList.add('hidden'); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            showMessageBox('åˆ°ç€ã—ã¾ã—ãŸï¼ğŸ‰ æ¬¡ã®ç›®çš„åœ°ã¸é€²ã‚€ã‚ˆï¼');
            // æ¬¡ã®æ¡ˆå†…ã«é€²ã‚€
            if (currentGuidanceIndex < currentRouteGuidance.length - 1) {
                currentGuidanceIndex++;
                speakGuidance(currentRouteGuidance[currentGuidanceIndex].text);
                updateGuidanceDisplay(); // å¼·èª¿è¡¨ç¤ºã‚‚æ›´æ–°
            }
            if (currentGuidanceIndex === currentRouteGuidance.length - 1) {
                // ã‚´ãƒ¼ãƒ«ã«åˆ°é”ã—ãŸã‚‰ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                startGuidanceButton.disabled = true;
                checkArrivalButton.disabled = true;
                nextGuidanceButton.disabled = true;
            }
        });

        // åˆ°ç€ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã€Œã„ã„ãˆã€é•ã„ã¾ã—ãŸã€ãƒœã‚¿ãƒ³
        confirmArrivalNo.addEventListener('click', () => {
            arrivalConfirmationModal.classList.add('hidden'); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            feedbackModal.classList.remove('hidden'); // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            feedbackInput.value = ''; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            feedbackInput.focus(); // å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        });

        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã€Œé€ä¿¡ï¼ã€ãƒœã‚¿ãƒ³
        submitFeedback.addEventListener('click', () => {
            const correctedName = feedbackInput.value.trim();
            if (correctedName) {
                // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¯¾è±¡ã¯ç¾åœ¨ã®æ¡ˆå†…ã§ã¯ãªãã€æ¬¡ã®ç›®çš„åœ°ï¼ˆcurrentGuidanceIndex + 1ï¼‰
                const targetGuidanceIndexForFeedback = currentGuidanceIndex + 1;
                const targetGuidance = currentRouteGuidance[targetGuidanceIndexForFeedback];

                if (targetGuidance && targetGuidance.targetCoords) {
                    const key = coordsToKey(targetGuidance.targetCoords[0], targetGuidance.targetCoords[1]);
                    saveFeedback(key, correctedName);
                    showMessageBox(`ã€Œ${targetGuidance.originalName || targetGuidance.text.replace('æ¬¡ã«', '').replace('ã¾ã§å‘ã‹ã£ã¦ãã ã•ã„ã€‚', '')}ã€ã¯ã€Œ${correctedName}ã€ã¨ã—ã¦è¨˜æ†¶ã—ãŸã‚ˆï¼ã‚ã‚ŠãŒã¨ã†ï¼ğŸ˜Š`);

                    // æ¡ˆå†…ãƒ†ã‚­ã‚¹ãƒˆã‚‚æ›´æ–°ï¼ˆè¡¨ç¤ºä¸Šï¼‰
                    targetGuidance.text = `æ¬¡ã«${correctedName}ã¾ã§å‘ã‹ã£ã¦ãã ã•ã„ã€‚`;

                    // ãƒãƒ¼ã‚«ãƒ¼ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚‚æ›´æ–° (å¼·èª¿è¡¨ç¤ºãƒãƒ¼ã‚«ãƒ¼ãŒå¯¾è±¡)
                    if (highlightedMarker) {
                         highlightedMarker.bindPopup(correctedName).openPopup();
                    }
                }
            } else {
                showMessageBox('ã”ã‚ã‚“ã­ã€ä½•ã‹å…¥åŠ›ã—ã¦ã»ã—ã„ãªï¼');
            }
            feedbackModal.classList.add('hidden'); // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¾Œã‚‚æ¬¡ã®æ¡ˆå†…ã«é€²ã‚€
            if (currentGuidanceIndex < currentRouteGuidance.length - 1) {
                currentGuidanceIndex++;
                speakGuidance(currentRouteGuidance[currentGuidanceIndex].text);
                updateGuidanceDisplay(); // å¼·èª¿è¡¨ç¤ºã‚‚æ›´æ–°
            }
            if (currentGuidanceIndex === currentRouteGuidance.length - 1) {
                startGuidanceButton.disabled = true;
                checkArrivalButton.disabled = true;
                nextGuidanceButton.disabled = true;
            }
        });

        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³
        cancelFeedback.addEventListener('click', () => {
            feedbackModal.classList.add('hidden'); // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            showMessageBox('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‚ˆã€‚');
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã‚‚æ¬¡ã®æ¡ˆå†…ã«é€²ã‚€
            if (currentGuidanceIndex < currentRouteGuidance.length - 1) {
                currentGuidanceIndex++;
                speakGuidance(currentRouteGuidance[currentGuidanceIndex].text);
                updateGuidanceDisplay(); // å¼·èª¿è¡¨ç¤ºã‚‚æ›´æ–°
            }
            if (currentGuidanceIndex === currentRouteGuidance.length - 1) {
                startGuidanceButton.disabled = true;
                checkArrivalButton.disabled = true;
                nextGuidanceButton.disabled = true;
            }
        });


        // æ¬¡ã®æ¡ˆå†…ã¸é€²ã‚€é–¢æ•° (æ‰‹å‹•)
        nextGuidanceButton.addEventListener('click', () => {
            if (currentGuidanceIndex < currentRouteGuidance.length - 1) {
                currentGuidanceIndex++;
                speakGuidance(currentRouteGuidance[currentGuidanceIndex].text);
                updateGuidanceDisplay(); // å¼·èª¿è¡¨ç¤ºã‚‚æ›´æ–°
            } else {
                showMessageBox('ã™ã¹ã¦ã®æ¡ˆå†…ãŒçµ‚äº†ã—ãŸã‚ˆï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ğŸ˜Š');
                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                startGuidanceButton.disabled = true;
                checkArrivalButton.disabled = true;
                nextGuidanceButton.disabled = true;
            }
        });

        // æ¡ˆå†…ã‚’éŸ³å£°ã§èª­ã¿ä¸Šã’ã‚‹é–¢æ•°
        function speakGuidance(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ja-JP'; // æ—¥æœ¬èªã‚’è¨­å®š
                window.speechSynthesis.speak(utterance);
            } else {
                console.warn('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°åˆæˆã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
                showMessageBox('ã”ã‚ã‚“ã­ã€ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°åˆæˆã«å¯¾å¿œã—ã¦ã„ãªã„ã¿ãŸã„...ï¼');
            }
        }

        // æ¡ˆå†…è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateGuidanceDisplay() {
            guidanceDisplay.innerHTML = ''; // å…¨ã¦ã®æ¡ˆå†…ã‚’ã‚¯ãƒªã‚¢
            currentRouteGuidance.forEach((guidance, index) => {
                const p = document.createElement('p');
                p.textContent = `${index + 1}. ${guidance.text}`;
                if (index === currentGuidanceIndex) {
                    p.classList.add('font-bold', 'text-blue-700', 'text-lg'); // ç¾åœ¨ã®æ¡ˆå†…ã‚’å¼·èª¿
                }
                guidanceDisplay.appendChild(p);
            });
            // ç¾åœ¨ã®æ¡ˆå†…ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            const currentElement = guidanceDisplay.querySelector('.font-bold');
            if (currentElement) {
                currentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // ãƒãƒ¼ã‚«ãƒ¼ã®å¼·èª¿è¡¨ç¤ºã‚’æ›´æ–°
            // ä»¥å‰ã«å¼·èª¿è¡¨ç¤ºã•ã‚ŒãŸãƒãƒ¼ã‚«ãƒ¼ãŒã‚ã‚Œã°å…ƒã«æˆ»ã™
            if (highlightedMarker) {
                highlightedMarker.setIcon(defaultIcon);
                highlightedMarker = null; // ãƒªã‚»ãƒƒãƒˆ
            }

            // æ¬¡ã®ç›®çš„åœ°ãŒã‚ã‚‹ã‹ç¢ºèª (ç¾åœ¨ã®æ¡ˆå†…ãŒæœ€çµ‚æ¡ˆå†…ã§ãªã‘ã‚Œã°)
            if (currentGuidanceIndex < currentRouteGuidance.length - 1) {
                const nextGuidanceItem = currentRouteGuidance[currentGuidanceIndex + 1];
                // ã‚´ãƒ¼ãƒ«åœ°ç‚¹ã®æ¡ˆå†…ã«ã¯targetCoordsãŒãªã„ã®ã§ã‚¹ã‚­ãƒƒãƒ—
                if (nextGuidanceItem && nextGuidanceItem.targetCoords) {
                    const nextTargetLat = nextGuidanceItem.targetCoords[0];
                    const nextTargetLon = nextGuidanceItem.targetCoords[1];

                    // æ¬¡ã®ç›®çš„åœ°ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã—ã¦å¼·èª¿è¡¨ç¤º
                    // currentDestinationMarkersã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ã€currentRouteGuidanceã®1ã‹ã‚‰å§‹ã¾ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¯¾å¿œ
                    // currentRouteGuidance[0]ã¯ã€ŒãŠæ•£æ­©é–‹å§‹ã€ãªã®ã§ã€ãƒãƒ¼ã‚«ãƒ¼ã¯currentRouteGuidance[1]ã‹ã‚‰å§‹ã¾ã‚‹
                    // ãªã®ã§ã€currentDestinationMarkers[currentGuidanceIndex]ãŒæ¬¡ã®ç›®çš„åœ°ãƒãƒ¼ã‚«ãƒ¼ã«ãªã‚‹
                    if (currentGuidanceIndex + 1 < currentRouteGuidance.length - 1) { // æœ€å¾Œã®ã€Œã‚´ãƒ¼ãƒ«ã€æ‰‹å‰ã¾ã§
                        const markerIndex = currentGuidanceIndex; // currentRouteGuidanceã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨ãƒãƒ¼ã‚«ãƒ¼é…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’åˆã‚ã›ã‚‹
                        if (markerIndex >= 0 && markerIndex < currentDestinationMarkers.length) {
                             const marker = currentDestinationMarkers[markerIndex];
                             marker.setIcon(highlightedIcon);
                             highlightedMarker = marker;
                             // å¼·èª¿è¡¨ç¤ºã•ã‚ŒãŸãƒãƒ¼ã‚«ãƒ¼ã«åœ°å›³ã‚’ãƒ‘ãƒ³ã™ã‚‹
                             map.panTo(marker.getLatLng());
                        }
                    }
                }
            }
        }

        // Leafletãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
        function initializeMap(latitude, longitude) {
            console.log('initializeMap called. Type of L:', typeof L); // Debugging line
            mapLoading.classList.remove('hidden'); // åœ°å›³èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤ºã‚’å‡ºã™

            // ãƒãƒƒãƒ—ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ç ´æ£„ã—ã¦å†ä½œæˆ
            if (map) {
                map.remove();
            }
            // åœ°å›³ã®ä¸­å¿ƒã‚’ç¾åœ¨åœ°ï¼ˆã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã«è¨­å®šã—ã€ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’æŒ‡å®š
            map = L.map('map').setView([latitude, longitude], 15); // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«15

            // OpenStreetMapã®ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ  (å¸¸ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³)
            if (currentMarker) {
                map.removeLayer(currentMarker); // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
            }
            currentMarker = L.marker([latitude, longitude], { icon: defaultIcon }).addTo(map)
                .bindPopup('ç¾åœ¨åœ°ã ã‚ˆï¼')
                .openPopup();

            // ãƒãƒƒãƒ—ã®è¡¨ç¤ºã‚’å¼·åˆ¶çš„ã«æ›´æ–°ï¼ˆä¸€éƒ¨ç’°å¢ƒã§è¡¨ç¤ºã•ã‚Œãªã„å•é¡Œå¯¾ç­–ï¼‰
            // Leafletã¯ã‚³ãƒ³ãƒ†ãƒŠã®ã‚µã‚¤ã‚ºãŒç¢ºå®šã—ãŸå¾Œã«invalidateSizeã‚’å‘¼ã¶å¿…è¦ãŒã‚ã‚‹
            // åœ°å›³ã‚¿ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰ãƒ­ãƒ¼ãƒ‰è¡¨ç¤ºã‚’éš ã™
            map.on('load', () => {
                map.invalidateSize(); // åœ°å›³ã®ã‚µã‚¤ã‚ºã‚’å†è¨ˆç®—
                mapLoading.classList.add('hidden'); // ãƒ­ãƒ¼ãƒ‰è¡¨ç¤ºã‚’éš ã™
            });

            // ã‚‚ã—loadã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆç¨€ã«ç™ºç”Ÿï¼‰
            setTimeout(() => {
                if (!mapLoading.classList.contains('hidden')) {
                    map.invalidateSize();
                    mapLoading.classList.add('hidden');
                }
            }, 3000); // 3ç§’å¾Œã«å¼·åˆ¶çš„ã«ãƒ­ãƒ¼ãƒ‰è¡¨ç¤ºã‚’éš ã™
        }

        // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«ç¾åœ¨åœ°ã‚’å–å¾—ã—ã€ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (typeof L === 'undefined') {
                    console.error('Leaflet (L) is not defined. Map cannot be initialized. This might be due to a network issue or security policy blocking Leaflet CDN.');
                    showMessageBox('ã”ã‚ã‚“ã­ï¼åœ°å›³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸã¿ãŸã„...ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ã­ï¼');
                    return;
                }

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            currentLat = position.coords.latitude;
                            currentLon = position.coords.longitude;
                            console.log('ç¾åœ¨åœ°ã‚’å–å¾—ã—ãŸã‚ˆï¼ ç·¯åº¦:', currentLat, 'çµŒåº¦:', currentLon);
                            initializeMap(currentLat, currentLon);
                        },
                        (error) => {
                            console.error('ç¾åœ¨åœ°ã®å–å¾—ã«å¤±æ•—ã—ãŸã‚ˆ:', 'ã‚³ãƒ¼ãƒ‰:', error.code, 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', error.message);
                            let errorMessage = 'ç¾åœ¨åœ°ã®å–å¾—ã«å¤±æ•—ã—ãŸã‚ˆã€‚è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã­ï¼';
                            if (error.code === 1) {
                                if (error.message.includes('permissions policy')) {
                                    errorMessage = 'ã”ã‚ã‚“ã­ï¼ã“ã®ç’°å¢ƒã§ã¯ä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã§ç„¡åŠ¹ã«ãªã£ã¦ã„ã‚‹ã¿ãŸã„ã€‚é€šå¸¸ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯å‹•ãã‚ˆï¼';
                                } else {
                                    errorMessage = 'ä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒæ‹’å¦ã•ã‚ŒãŸã‚ˆã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ã­ï¼';
                                }
                            } else if (error.code === 2) {
                                errorMessage = 'ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ããªã„ã‚ˆã€‚é›»æ³¢çŠ¶æ³ãŒæ‚ªã„ã‹ã€GPSãŒã‚ªãƒ•ã«ãªã£ã¦ã„ã‚‹ã‹ã‚‚ï¼Ÿ';
                            } else if (error.code === 3) {
                                errorMessage = 'ç¾åœ¨åœ°ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸã‚ˆã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ã­ï¼';
                            }
                            showMessageBox(errorMessage);
                            initializeMap(currentLat, currentLon);
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                    console.warn('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
                    showMessageBox('ã”ã‚ã‚“ã­ã€ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ãªã„ã¿ãŸã„...ï¼');
                    initializeMap(currentLat, currentLon);
                }
            }, 100);
        });

    </script>
</body>
</html>
